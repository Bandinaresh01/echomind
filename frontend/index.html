<!DOCTYPE html>
<html>
<head>
  <title>EchoMind Voice Assistant</title>
  <script src="https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.umd.js"></script>
</head>
<body>
  <h2>EchoMind ‚Äì Speak</h2>

  <button id="btn" onclick="toggle()">üé§ Start</button>
  <p id="status"></p>

  <h3>Recognized Text:</h3>
  <div id="output" style="font-size:18px;color:green;"></div>

  <script>
    const LK = window.LiveKitClient || window.LivekitClient;

    let room = null;
    let running = false;

    function setStatus(s) {
      document.getElementById("status").innerText = s;
      console.log(s);
    }

    async function toggle() {
      if (!running) return start();
      return stop();
    }

    async function start() {
      const btn = document.getElementById("btn");
      btn.disabled = true;

      try {
        setStatus("Fetching token...");
        const res = await fetch("/token");
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        setStatus("Connecting to LiveKit...");
        room = new LK.Room();
        await room.connect(data.url, data.token);

        setStatus("Enabling microphone...");
        await room.localParticipant.setMicrophoneEnabled(true);

        running = true;
        btn.innerText = "üõë Stop";
        setStatus("‚úÖ Mic enabled. Speak now!");

      } catch (e) {
        console.error(e);
        setStatus("‚ùå ERROR: " + (e.message || e));
      } finally {
        btn.disabled = false;
      }
    }

    async function stop() {
      const btn = document.getElementById("btn");
      btn.disabled = true;

      try {
        setStatus("Stopping...");
        if (room) {
          await room.localParticipant.setMicrophoneEnabled(false);
          room.disconnect();
          room = null;
        }
        running = false;
        btn.innerText = "üé§ Start";
        setStatus("Stopped.");
      } catch (e) {
        console.error(e);
        setStatus("‚ùå Stop error: " + (e.message || e));
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
